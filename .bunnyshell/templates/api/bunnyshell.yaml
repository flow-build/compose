kind: Environment
name: flowbuild
type: primary
environmentVariables:
    POSTGRES_HOST: postgres
    POSTGRES_PASSWORD: replace-me
    POSTGRES_USER: postgres
    POSTGRES_PORT: 5432
    ENGINE_HEARTBEAT: true
    ENGINE_LOG_LEVEL: info
    HTTP_TIMEOUT: '30000'
    JWT_KEY: '1234'
    KNEX_ENV: prod
    KOA_LOG_LEVEL: info
    MAX_BODY_LENGTH: '123456789'
    MAX_CONTENT_LENGTH: '123456789'
    MAX_STEP_NUMBER: '20'
    MQTT: 'false'
    NODE_ENV: prod
    PUBLISH_ENGINE_LOGS: 'false'
    PUBLISH_SERVER_LOGS: 'false'
    PUBLISH_STATE_EVENTS: 'false'
    TIMER_QUEUE: timer
    TIMER_PORT: 6379
    TIMER_HOST: redis
    FLOWBUILD_URL: 'https://flowbuild-{{ env.base_domain }}'
components:
    -
        kind: Database
        name: postgres
        dockerCompose:
            image: 'postgres:14.7-alpine'
            ports:
                - '5432:5432'
            restart: always
            environment:
                POSTGRES_DB: workflow
            labels:
                app: postgres
        volumes:
            -
                name: data-volume
                mount: /var/lib/postgresql/data
                subPath: ''
    -
        kind: Database
        name: redis
        dockerCompose:
            image: 'redis:7-bullseye'
            ports:
                - '6379:6379'
            restart: always
            labels:
                app: redis
    -
        kind: Application
        name: flowbuild
        gitRepo: 'https://github.com/flow-build/workflow-api.git'
        gitBranch: master
        gitApplicationPath: /
        dockerCompose:
            image: 'flowbuild/server:2.22.4'
            deploy:
              resources:
                limits:
                  memory: 1G
                reservations:
                  memory: 1G
            environment:
                NEW_RELIC_ENABLED: '0'
                POSTGRES_DATABASE: workflow
            ports:
                - '3000:3000'
            command: 'bash -c " npm run migrations && npm run seeds && npm start"'
            healthcheck:
                interval: 1m
                retries: 3  
                start_period: 1m
                test:
                    - CMD
                    - curl
                    - '-f'
                    - 'http://localhost:3000/healthcheck'
                timeout: 10s
        hosts:
            -
                hostname: 'flowbuild-{{ env.base_domain }}'
                path: /
                servicePort: 3000
    -
        kind: Application
        name: timer-worker
        gitRepo: 'https://github.com/flow-build/timer-worker.git'
        gitBranch: main
        gitApplicationPath: /
        dockerCompose:
            image: 'flowbuild/timer-worker:1.0.0-development.2'
            deploy:
              resources:
                limits:
                  memory: 1G
                reservations:
                  memory: 1G
            ports:
                - '3001:3001'
            healthcheck:
                interval: 1m
                retries: 3  
                start_period: 1m
                test:
                    - CMD
                    - curl
                    - '-f'
                    - 'http://localhost:3001/healthcheck'
                timeout: 10s
        hosts:
            -
                hostname: 'timer-{{ env.base_domain }}'
                path: /
                servicePort: 3001
volumes:
    -
        name: data-volume
        size: 1Gi
        type: disk